# Copyright (c) 2025, Marco Noce <nce.marco@gmail.com>
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Create fake imageinfo binary
  copy:
    dest: /usr/local/bin/imageinfo
    content: "{{ fake_imageinfo_output }}"
    mode: '0755'

- name: Create fake exadata.img.hw binary
  copy:
    dest: /usr/sbin/exadata.img.hw
    content: "{{ fake_exadata_hw_output }}"
    mode: '0755'

- name: Create fake dmidecode binary
  copy:
    dest: /usr/sbin/dmidecode
    content: "{{ fake_dmidecode_output }}"
    mode: '0755'

- name: Create directory for databasemachine.xml file
  file:
    path: /opt/oracle.SupportTools/onecommand
    state: directory
    mode: '0755'

- name: Create fake databasemachine.xml file
  copy:
    dest: /opt/oracle.SupportTools/onecommand/databasemachine.xml
    content: "{{ fake_databasemachine_xml }}"
    mode: '0644'

- name: Run exa_facts module to gather fake Exadata facts
  exa_facts:
  register: exa_result

- name: Assert that exa_img fact is gathered and contains production image type
  assert:
    that:
      - exa_result.ansible_facts.exa_img is defined
      - "'production' in exa_result.ansible_facts.exa_img['Image image type']"

- name: Assert that exa_hw fact is gathered and has the expected model
  assert:
    that:
      - exa_result.ansible_facts.exa_hw is defined
      - exa_result.ansible_facts.exa_hw.model == "HVM domU"

- name: Assert that system_info fact is gathered with correct SKU Number
  assert:
    that:
      - exa_result.ansible_facts.system_info is defined
      - exa_result.ansible_facts.system_info['SKU Number'] == "B88854"

- name: Assert that databasemachine fact is gathered and contains the Oracle Cluster name
  assert:
    that:
      - exa_result.ansible_facts.databasemachine is defined
      - exa_result.ansible_facts.databasemachine.databasemachine.ORACLE_CLUSTER.name == "TestCluster"

- name: Debug gathered exa_facts
  debug:
    var: exa_result.ansible_facts